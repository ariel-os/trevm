# wasm-coap-interop

## About

This example shows how to run a coap-server through a wasm capsule by deferring the processing of selects message (such as all those asking for a resource under `/vm`) to the capsule.

## Security

Secure connections are enabled by default, and required for all resources except discovery and `/vm/example`. Permissions are read and applied from [`peers.yml`](./peers.yml). At startup, you should see a log looking like
```sh
[INFO ] CoAP server identity: {8: ... }
```
<p style="color:red"> <b>Note :</b> </p>

> This will not work on the Pico boards because of a peripheral conflict between the wifi and storage modules. To still use them together, change `DMA_CH0` to `DMA_CH1` in [this file](../../build/imports/ariel-os/src/ariel-os-rp/src/storage.rs). Note that this link only works after `laze` has download the ariel-os repository in `build/imports/ariel-os`.

The credentials shipped with the example usually do not authenticate the server:
They just authorize the client.

If you want to authenticate the server,
edit [`client.diag`](./client.diag) and replace the `{"unauthenticated": true}` value with `{14: {8: …}}`,
where the `{8: …}` part comes from the server's output
and represents the identity generated by the device at first startup.

Note: OSCORE requires CoAP options to be sorted which is not currently guaranteed by our handler implementations. This could case the server to crash in some scenarios. In our testing, the worse we could achieve was to simply get a message rejected when it shouldn't have. In the current state, achieving this requires contrived examples which is why we still choose to showcase security options.

## How to run

Look [here](https://ariel-os.github.io/ariel-os/dev/docs/book/networking.html) for information about network configuration in Ariel OS.

```sh
# Example for running on the RP Pico 2 W using wifi
CONFIG_WIFI_NETWORK=... CONFIG_WIFI_PASSWORD=... laze build -b rpi-pico-2-w -s wifi-cyw43 -s coap-server-config-unprotected run
```

Once the server is set-up, in another terminal, you can send request by using
```sh
# optionally add --credential client.diag to use secure connections
pipx run --spec 'aiocoap[oscore, prettyprint]' aiocoap-client coap://<Address of the server>/vm/example
```

For most other resources, you will need to add `--credentials ./client.diag` to authorize the access.

It's possible to get the resource that are provided by the server by `GET`ting `.well-known/core`

This example has been tested on the following boards:
- NRF52840DK using the `usb-ethernet` and `network-config-ipv4-static` modules.
- RPI Pico 2 W using the `wifi-cyw43` and `network-config-ipv4-dhcp` modules.
- DFRobot FireBeetle 2 using the `espressif-esp32-c6-devkitc-1` builder and the `wifi-esp` and `network-config-ipv4-dhcp` modules.

## How to change the capsule's code

* Edit the example's source code in `../../payloads/coap-server-bindings/`,
  or build an own project in a similar way.

* Rebuild and upload the firmware:

  ```console
  $ ../../precompile_wasm.rs --path ../../payloads/coap-server-bindings/Cargo.toml -o payload.cwasm --config ../../payloads/.cargo/config.toml
  $ pipx run --spec 'aiocoap[oscore, prettyprint]' aiocoap-client coap://<Address of the server>/vm-control -m PUT --payload @./payload.cwasm --credentials ./client.diag
  ```
